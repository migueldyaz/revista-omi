<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>EPUB | Visor con índice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#fff; --fg:#111; --ui:#f3f4f6; --stroke:#e5e7eb; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    header{display:flex;gap:.5rem;align-items:center;padding:.6rem .9rem;background:var(--ui);
      border-bottom:1px solid var(--stroke); position:sticky; top:0; z-index:20}
    .wrap{display:grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 56px);}
    aside{border-right:1px solid var(--stroke); background:#fafafa; overflow:auto}
    #viewer{height:100%; overflow:auto}

    button,select,label{padding:.42rem .6rem; font-size:.95rem}
    .spacer{flex:1}
    .hamb{display:none}
    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr}
      aside{position:fixed; inset:56px auto 0 0; width: 78%; max-width: 320px; transform:translateX(-100%);
        transition: transform .25s ease; box-shadow: 0 8px 24px rgba(0,0,0,.15); z-index:25}
      aside.open{transform:translateX(0)}
      .hamb{display:inline-flex}
    }

    .toc{list-style:none; margin:0; padding:.5rem}
    .toc li{margin:.1rem 0}
    .toc a{display:block; padding:.35rem .5rem; border-radius:.45rem; text-decoration:none; color:inherit}
    .toc a:hover{background:#eef2ff}
    .toc a.active{background:#e0e7ff; color:#111; border:1px solid #c7d2fe}
    .toc .lvl-2 a{padding-left:1.25rem}
    .toc .lvl-3 a{padding-left:2rem}
  </style>
</head>
<body>
  <header>
    <button class="hamb" id="btnNav" aria-label="Índice">☰</button>
    <button id="prev" title="Anterior">⟨</button>
    <button id="next" title="Siguiente">⟩</button>

    <div class="spacer"></div>
    <label><input type="checkbox" id="modeToggle" checked /> Modo continuo</label>
    <button id="smaller" title="A−">A−</button>
    <button id="bigger" title="A+">A+</button>
    <button id="loadAll" title="Precargar todo">Cargar todo</button>
    <button id="resetPos" title="Olvidar posición y recargar">Reset lectura</button>
  </header>

  <div class="wrap">
    <aside id="panel">
      <div style="padding:.6rem .75rem; font-weight:600; border-bottom:1px solid var(--stroke); background:#fff">Índice</div>
      <ul id="toc" class="toc"></ul>
    </aside>

    <div id="viewer" aria-live="polite"></div>
  </div>

  <!-- Librerías -->
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs@0.3.93/dist/epub.min.js"></script>
  <script>
  const BOOK_URL = "art-005.epub";
  let book, rendition;

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const NS=k=>`omi.epub[${BOOK_URL}].${k}`, get=(k,d=null)=>localStorage.getItem(NS(k))??d, set=(k,v)=>localStorage.setItem(NS(k),v);

  // ===== CSS inyectado dentro de iframes =====
  const STATIC_IFRAME_CSS = `
    html, body { margin:0 !important; padding:0 !important; }
    .omi-reader { margin: 1.25rem auto; max-width: 980px; line-height: 1.6; }
    img, svg, video { max-width:100% !important; height:auto !important; }
    :root, html, body, * {
      -webkit-column-count: initial !important;
      -moz-column-count: initial !important;
      column-count: initial !important;
      -webkit-column-width: auto !important;
      -moz-column-width: auto !important;
      column-width: auto !important;
      -webkit-column-gap: normal !important;
      -moz-column-gap: normal !important;
      column-gap: normal !important;
      height:auto !important; min-height:0 !important; max-height:none !important;
      overflow: visible !important; position: static !important;
      page-break-before:auto !important; page-break-after:auto !important; page-break-inside:auto !important;
    }
    a{ color:#2563eb !important; text-decoration:none !important }
    h1{ font-size:1.6em !important } h2{ font-size:1.42em !important } h3{ font-size:1.34em !important } h4{ font-size:1.2em !important }
  `;
  const scaleSheet = pct => `
    html, body, .omi-reader { font-size: ${pct}%; }
    img, svg, video { image-rendering:auto; }
  `;
  const getScale=()=>parseInt(get("fs","100"),10);
  const setScale=v=>set("fs",String(v));

  // ===== Flags =====
  let PRELOADING = false;

  function registerContentHooks(){
    rendition.hooks.content.register(contents=>{
      const doc=contents.document;
      doc.documentElement.classList.add("omi-reader");
      if(!doc.head.querySelector("style[data-omi-static]")){
        const st=doc.createElement("style");
        st.setAttribute("data-omi-static","");
        st.textContent=STATIC_IFRAME_CSS;
        doc.head.appendChild(st);
      }
      let dyn=doc.head.querySelector("style[data-omi-scale]");
      if(!dyn){ dyn=doc.createElement("style"); dyn.setAttribute("data-omi-scale",""); doc.head.appendChild(dyn); }
      dyn.textContent=scaleSheet(getScale());
    });
  }
  function updateAllScales(p){
    (rendition?.getContents()||[]).forEach(c=>{
      const s=c.document.head.querySelector("style[data-omi-scale]");
      if(s) s.textContent=scaleSheet(p);
    });
  }

  // ===== Relocated SIN auto-next =====
  function onRelocated(loc){
    if (PRELOADING) return; // no tocar estado durante precarga
    const href=loc?.start?.href||"", cfiNow=loc?.start?.cfi||"";
    set("loc", cfiNow);
    if (window.highlightTOC) window.highlightTOC(href);
  }

  // ===== Precarga segura (sin mover al usuario) =====
  async function precargarTodoSilencioso(){
    if (!book || !rendition) return;
    PRELOADING = true;

    const spine = await book.loaded.spine;
    const container = $("#viewer");
    const prevOpacity = container.style.opacity;
    const cfiOrig = rendition.currentLocation()?.start?.cfi || get("loc", null) || null;

    // Pausar side-effects
    rendition.off("relocated", onRelocated);
    container.style.opacity = "0.01";

    try {
      const hrefNow = rendition.currentLocation()?.start?.href || "";
      const idxActual = spine.items.findIndex(it => it.href === hrefNow);
      const startIdx = idxActual >= 0 ? idxActual + 1 : 0;

      // Recorre el resto del spine, sin guardar posición
      for (let i = startIdx; i < spine.items.length; i++) {
        await rendition.display(spine.items[i].href);
        await new Promise(r=>requestAnimationFrame(()=>r()));
      }
      // Volver exactamente donde estaba
      await rendition.display(cfiOrig || hrefNow || undefined);
    } catch(e){
      console.warn("Precarga silenciosa falló:", e);
    } finally {
      // Reanudar side-effects
      rendition.on("relocated", onRelocated);
      container.style.opacity = prevOpacity || "";
      PRELOADING = false;
    }
  }

  // ===== Iniciar/alternar modo de lectura =====
  async function startRendition({continuous=true, cfi=null}={}){
    if(rendition){ try{ rendition.destroy(); }catch{} $("#viewer").innerHTML=""; }

    const container = $("#viewer");
    const dims = () => ({ w: container.clientWidth, h: container.clientHeight });

    const baseOpts = continuous
      ? { flow:"scrolled", manager:"continuous", spread:"none" }
      : { flow:"paginated", spread:"auto" };

    rendition = book.renderTo("viewer", { width:dims().w, height:dims().h, ...baseOpts });

    new ResizeObserver(()=>{ const {w,h}=dims(); rendition.resize(w,h); }).observe(container);

    registerContentHooks();
    updateAllScales(getScale());
    rendition.on("relocated", onRelocated);

    const enteredCfi = cfi || get("loc", null) || null;
    await rendition.display(enteredCfi || undefined);

    // Empuje por scroll (solo en continuo), con throttle
    let pushing=false, ticking=false;
    container.addEventListener("scroll", ()=>{
      if(!continuous || pushing || PRELOADING || ticking) return;
      ticking = true;
      requestAnimationFrame(()=>{
        const nearBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 600;
        if(nearBottom){
          pushing = true;
          rendition.next().finally(()=>{ pushing=false; });
        }
        ticking = false;
      });
    }, {passive:true});
  }

  // ===== TOC =====
  function buildTOC(navTOC){
    const ul=$("#toc"); ul.innerHTML="";
    const norm=h=>(h||"").split("#")[0];
    navTOC.forEach(item=>{
      const li=document.createElement("li");
      const depth=(item.parent?(item.parent.parent?3:2):1);
      li.className=`lvl-${depth}`;
      const a=document.createElement("a");
      a.href="javascript:void(0)"; a.dataset.href=item.href; a.textContent=item.label||item.text||"Sección";
      a.onclick=()=>rendition.display(item.href);
      li.appendChild(a); ul.appendChild(li);
      (item.subitems||[]).forEach(sub=>{
        const sli=document.createElement("li"); sli.className="lvl-2";
        const sa=document.createElement("a"); sa.href="javascript:void(0)"; sa.dataset.href=sub.href; sa.textContent=sub.label||sub.text||"Sección";
        sa.onclick=()=>rendition.display(sub.href); sli.appendChild(sa); ul.appendChild(sli);
      });
    });
    window.highlightTOC=currentHref=>{
      const cur=norm(currentHref||"");
      $$(".toc a").forEach(a=>a.classList.toggle("active", norm(a.dataset.href||"")===cur));
    };
  }

  // ===== Boot =====
  (async function(){
    try{
      const res=await fetch(BOOK_URL,{cache:"no-store"}); const buf=await res.arrayBuffer();
      book=ePub(buf);

      const nav=await book.loaded.navigation; buildTOC(nav.toc || []);
      const continuousDefault = get("continuous","1")==="1";
      await startRendition({continuous: continuousDefault});

      // Precarga diferida y segura
      setTimeout(()=>{ precargarTodoSilencioso(); }, 150);

      // Controles
      $("#prev").onclick=()=>rendition.prev();
      $("#next").onclick=()=>rendition.next();

      const clamp=v=>Math.max(70,Math.min(200,v));
      $("#bigger").onclick=()=>{ const n=clamp(getScale()+10); setScale(n); updateAllScales(n); };
      $("#smaller").onclick=()=>{ const n=clamp(getScale()-10); setScale(n); updateAllScales(n); };

      $("#modeToggle").checked = continuousDefault;
      $("#modeToggle").addEventListener("change", async e=>{
        const cont=e.target.checked; set("continuous",cont?"1":"0");
        const cfi=rendition.currentLocation()?.start?.cfi||null;
        await startRendition({continuous:cont, cfi});
        setTimeout(()=>{ precargarTodoSilencioso(); }, 150);
      });

      $("#loadAll").onclick = precargarTodoSilencioso;

      $("#resetPos").onclick = async ()=>{
        try { localStorage.removeItem(NS("loc")); } catch {}
        await startRendition({ continuous: true, cfi: null });
        setTimeout(()=>{ precargarTodoSilencioso(); }, 150);
      };

      // Hamburguesa móvil
      const panel=$("#panel");
      $("#btnNav").onclick=()=>panel.classList.toggle("open");
      $("#toc").addEventListener("click",()=>panel.classList.remove("open"));

    }catch(err){
      console.error("Error inicializando visor:",err);
      alert("No se pudo abrir el EPUB. Revisa la consola.");
    }
  })();
</script>


</body>
</html>
